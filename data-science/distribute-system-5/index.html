<!DOCTYPE html> <html lang="en"> <head> <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {
          equationNumbers: {
            autoNumber: "AMS"
          }
        },
        tex2jax: {
        inlineMath: [ ['$', '$'] ],
        displayMath: [ ['$$', '$$'] ],
        processEscapes: true,
      }
    });
    MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
          alert("Math Processing Error: "+message[1]);
        });
    </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>배치형, 스트리밍형의 데이터 플로우 | Seoyoung Hong</title> <meta name="author" content="Seoyoung Hong"/> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://seoyoungh.github.io/data-science/distribute-system-5/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Seoyoung </span>Hong</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">배치형, 스트리밍형의 데이터 플로우</h1> <p class="post-meta">August 13, 2020</p> <p class="post-tags"> <a href="/blog/2020"> <i class="fas fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/data-engineering"> <i class="fas fa-hashtag fa-sm"></i> data-engineering</a>   <a href="/blog/tag/database"> <i class="fas fa-hashtag fa-sm"></i> database</a>   <a href="/blog/tag/data-science"> <i class="fas fa-hashtag fa-sm"></i> data-science</a>     ·   <a href="/blog/category/data-science"> <i class="fas fa-tag fa-sm"></i> data-science</a>   </p> </header> <article class="post-content"> <p>아래 대부분의 내용은 도서 <strong>빅데이터를 지탱하는 기술</strong>에서 발췌했습니다.</p> <h4 id="map-and-reduce">Map and Reduce</h4> <ul> <li> <code class="language-plaintext highlighter-rouge">Map</code>: 분할된 텍스트를 단어별로 수를 카운트</li> <li> <code class="language-plaintext highlighter-rouge">Reduce</code>: 단어별 합계를 계산</li> <li>Map과 Reduce를 여러번 반복하며 결과를 얻음</li> </ul> <p><br></p> <h4 id="데이터-플로우">데이터 플로우</h4> <ul> <li> <code class="language-plaintext highlighter-rouge">데이터 플로우</code> <ul> <li>다단계의 데이터 처리를 그대로 분산 시스템 내부에서 실행하는 것</li> <li>MapReduce와 같은 외부 도구에 의존하는 <code class="language-plaintext highlighter-rouge">워크플로</code>와 구분</li> </ul> </li> <li>MapReduce를 <code class="language-plaintext highlighter-rouge">MillWheel</code>, <code class="language-plaintext highlighter-rouge">Tez</code>, <code class="language-plaintext highlighter-rouge">Spark</code> 등의 프레임워크가 대체하고 있음</li> </ul> <p><br></p> <h5 id="dag">DAG</h5> <ul> <li> <code class="language-plaintext highlighter-rouge">DAG</code> <ul> <li><strong>방향성 비순환 그래프 directed acyclic graph</strong></li> <li>새 프레임워크에 공통으로 들어가는 데이터 구조</li> <li>DAG의 성질 <ul> <li>방향성: 노드와 노드가 화살표로 연결된다.</li> <li>비순환: 화살표를 아무리 따라가도 동일 노드로는 되돌아오지 않는다.</li> </ul> </li> <li>MapReduce에서는 하나의 노드에서 처리가 끝나지 않으면 다음 처리로 진행할 수 없어 비효율적이었는데, 데이터 플로우에서는 DAG를 구성하는 각 노드가 모두 동시 병행으로 실행된다. 처리가 끝난 데이터는 네트워크를 거쳐 차례대로 전달되어 대기 시간을 없앤다.</li> <li> <strong>lazy evaluation</strong> <ul> <li>프로그램의 각 행은 DAG의 데이터 구조를 조립하고 있을 뿐, 뭔가를 처리하지는 않음</li> <li>먼저 데이터 파이프라인 전체를 DAG로 조립하고 나서 실행해 옮김으로써 내부 스케줄러가 분산 시스템에 효과적인 실행 계획을 세워줌</li> </ul> </li> </ul> </li> </ul> <p><br></p> <h5 id="단어를-세는-spark-프로그램-배치">단어를 세는 Spark 프로그램 (배치)</h5> <p>데이터 처리를 하는 파이썬 스크립트의 예시</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 파일로부터 데이터를 읽어들임
</span><span class="n">lines</span> <span class="o">=</span> <span class="n">sc</span><span class="p">.</span><span class="nf">textfile</span><span class="p">(</span><span class="sh">"</span><span class="s">sample.txt</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># 파일의 각 행을 단어로 분해
</span><span class="n">words</span> <span class="o">=</span> <span class="n">lines</span><span class="p">.</span><span class="nf">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">())</span>
<span class="c1"># 단어마다의 카운터를 파일에 출력
</span><span class="n">words</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> \
     <span class="p">.</span><span class="nf">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> \
     <span class="p">.</span><span class="nf">saveAsTextFile</span><span class="p">(</span><span class="sh">"</span><span class="s">word_counts</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># 여기서 실행 개시
</span></code></pre></div></div> <p><br></p> <h5 id="dag-1">DAG</h5> <ol> <li>textFile()</li> <li>flatMap()</li> <li>map()</li> <li>reduceByKey()</li> <li>saveAsTextFile()</li> </ol> <p><br></p> <h4 id="데이터-플로우와-워크플로-조합하기">데이터 플로우와 워크플로 조합하기</h4> <ul> <li>태스크의 정기적인 실행, 실패한 태스크를 기록하여 복구하는 것은 데이터 플로우에서 할 수 없으므로 워크플로 관리가 필요함</li> <li>분산 시스템 안에서만 실행되는 데이터 처리라면 하나의 데이터 플로우로 기술할 수 있겠지만, 분산 시스템 외부와 데이터를 주고 받을 경우는 언제 어떤 오류가 생길지 모르므로 복구를 고려해 워크플로 안에서 실행하는 것이 바람직하다.</li> </ul> <p><br></p> <h5 id="데이터-읽어-들이는--써서-내보내는-플로우">데이터 읽어 들이는 / 써서 내보내는 플로우</h5> <ul> <li>데이터 플로우 실행 과정에서 데이터 소스에 직접 액세스하면 성능 문제를 일으키기 쉽다.</li> <li>데이터 플로우로부터 <strong>읽어 들일 데이터</strong>는 성능적으로 안정된 분산 스토리지에 <strong>복사</strong>함으로써 안정적으로 사용한다.</li> <li>외부의 데이터 소스에서 데이터를 읽어 들일 때는 어떤 오류가 발생할 지 예측할 수 없으므로 워크플로, 벌크 형의 전송 도구로 태스크를 구현한다.</li> <li>분산 스토리지에 복사한 후로는 데이터 플로우의 전문 분야이다.</li> <li>외부 시스템에 <strong>써서 내보내는 경우</strong>에는, 분산 스토리지에 취급하기 쉬운 csv와 같은 형태로 변환해 써넣고, 워크플로 안에서 외부 시스템으로 데이터를 전송한다.</li> </ul> <p><br></p> <h3 id="배치-처리">배치 처리</h3> <h4 id="스트리밍-형의-데이터-플로우">스트리밍 형의 데이터 플로우</h4> <ul> <li>데이터의 실시간 처리를 높이려면, 배치 처리와는 전혀 다른 데이터 파이프라인이 필요</li> <li>배치 처리를 중심으로 하는 데이터 파이프라인은 데이터가 분석할 수 있게 될 때까지 시간이 걸린다.</li> <li>예로, 열 지행 스토리지를 만들기 위해 데이터를 모아 변환하는 데 일정 시간이 필요하다.</li> <li> <strong>이벤트 발생에서 몇 초 후에는 결과를 알 수 있는</strong> 실시간의 데이터 처리에서는 그런 과정을 생략한 별개의 계통으로 파이프라인을 만든다.</li> <li> <code class="language-plaintext highlighter-rouge">스트림 처리</code> <ul> <li>분산 스토리지를 거치지 않고 처리를 계속하는 것</li> </ul> </li> <li>데이터 양이 너무 많아 분산 스토리지의 비용상, 성능상 한계를 넘어선다면 스트림 처리를 사용해 현실적인 흐름량을 줄일 수도 있음</li> <li>1초마다 통계량만 저장하고 싶으면 집계를 스트림 처리에 맡길 수도 있음</li> </ul> <p><br></p> <h5 id="실시간-성이-높은-데이터-처리-시스템의-예">실시간 성이 높은 데이터 처리 시스템의 예</h5> <ul> <li>시스템 모니터링 <ul> <li>서버와 네트워크의 상태를 감시하고 그 시간 추이를 그래프로 표시</li> </ul> </li> <li>로그 관리 시스템 <ul> <li>운영체제의 시스템 이벤트나 로그 파일을 검색해 비정상적인 상태라면 경고를 생성</li> </ul> </li> <li>복합 이벤트 처리 <ul> <li>다수의 업무 시스템으로부터 보내온 이벤트를 자동으로 처리</li> </ul> </li> </ul> <p><br></p> <h5 id="스트림-처리와-배치-처리의-차이">스트림 처리와 배치 처리의 차이</h5> <p><img src="/assets/images/batch_stream.JPG" alt="batch_stream" width="60%" height="60%"></p> <ul> <li>데이터를 작게 분할해 DAG에서 실행한다는 점에서는 같음</li> <li>데이터의 처리가 끝나면 배치 처리는 종료, 반면 스트림 처리는 프로그램을 정지할 때까지 끝없이 실행이 계속됨</li> <li>하나의 프레임 워크에서 통합적인 데이터 처리를 기술할 수 있다는 점이 데이터 플로우의 장점</li> </ul> <p><br></p> <h5 id="단어를-세는-spark-프로그램-스트림">단어를 세는 Spark 프로그램 (스트림)</h5> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1초마다 스트림 처리를 한다.
</span><span class="n">sc</span> <span class="o">=</span> <span class="nc">SparkContext</span><span class="p">(</span><span class="sh">"</span><span class="s">local[2]</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NetworkWordCount</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ssc</span> <span class="o">=</span> <span class="nc">StreamingContext</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># TCP 포트 9999로부터 데이터를 읽어들인다.
</span><span class="n">lines</span> <span class="o">=</span> <span class="n">ssc</span><span class="p">.</span><span class="nf">socketTextStream</span><span class="p">(</span><span class="sh">"</span><span class="s">localhost</span><span class="sh">"</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>
<span class="c1"># 파일의 각 행을 단어로 분해
</span><span class="n">words</span> <span class="o">=</span> <span class="n">lines</span><span class="p">.</span><span class="nf">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">())</span>
<span class="c1"># 단어별 개수를 콘솔에 출력
</span><span class="n">words</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> \
     <span class="p">.</span><span class="nf">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> \
     <span class="p">.</span><span class="nf">pprint</span><span class="p">()</span>
<span class="c1"># 스트림 처리를 시작한다.
</span><span class="n">ssc</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre></div></div> <p><br></p> <h4 id="람다-아키텍처">람다 아키텍처</h4> <p><img src="/assets/images/lambda.JPG" alt="lambda" width="60%" height="60%"></p> <ul> <li>스트림 처리는 잘못된 집계를 다시 하는 것이 어렵고, 늦게 전송된 데이터 취급이 어려우므로 배치 처리와 조합시켜 2계통의 데이터 처리를 하게 된다. <ul> <li>e.g.) 일별 보고서는 속보 값으로, 월별 보고서를 확정 값으로 분류</li> </ul> </li> <li>람다 아키텍처의 도입은 시스템을 복잡하게 하는 요인이 되므로, 꼭 필요하지 않은 경우 스트림 처리의 도입에는 신중해야 한다.</li> <li> <strong>데이터 파이프라인을 3개의 레이어로 구분</strong> <ul> <li>모든 데이터는 반드시 <strong>배치 레이어</strong>에서 처리</li> <li>데이터 처리 결과는 <strong>서빙 레이어</strong>를 통해 접근 <ul> <li> <strong>배치 뷰</strong>: 서빙 레이어에서 얻어진 결과, 정기적으로 업데이트 되고 실시간 정보는 얻을 수 없음</li> </ul> </li> <li> <strong>스피드 레이어</strong> <ul> <li> <strong>실시간 뷰</strong>: 스피드 레이어에서 얻은 결과</li> <li>실시간 뷰는 배치 뷰가 업데이트될 동안까지만 이용되고 오래된 데이터는 순서대로 삭제됨</li> </ul> </li> <li>배치 뷰와 실시간 뷰 모두를 조합시키는 형태로 쿼리를 실행</li> </ul> </li> <li>문제점: <strong>나쁜 개발 효율</strong> <ul> <li>스피드 레이어, 배치 레이어는 모두 똑같은 처리를 구현하고 있어 번거로움</li> </ul> </li> </ul> <p><br></p> <h5 id="카파-아키텍처">카파 아키텍처</h5> <ul> <li>람다 아키첵처를 단순화함</li> <li>배치 레이어, 서빙 레이어를 제거하고 스피드 레이어만 남기는 대신 메시지 브로커의 데이터 보관 기간을 충분히 길게 하여 문제가 발생했을 때 메시지 배송 시간을 다시 과거로 설정한다.</li> <li>문제점: 부하가 높음 <ul> <li>스트림 처리의 데이터 플로우에 대량의 과거 데이터를 흘려 보매념 계산 자원을 일시적으로 과다하게 소비함</li> <li>클라우드 서비스 보급으로 이러한 자원 확보가 어렵지 않게 되어서 필요에 따라서는 스트림 처리를 다시 하는 것이 간단하다는 것이 카파 아키텍처의 생각</li> </ul> </li> </ul> <p><br></p> <h4 id="빅데이터-분석-기반의-예">빅데이터 분석 기반의 예</h4> <p><img src="/assets/images/bigdata_flow.JPG" alt="bigdata_flow" width="60%" height="60%"></p> <p><br></p> <h4 id="aws-데이터-파이프라인-예시">AWS 데이터 파이프라인 예시</h4> <p><img src="/assets/images/aws.JPG" alt="aws" width="60%" height="60%"></p> <p><br></p> <h4 id="gcp-데이터-파이프라인-예시">GCP 데이터 파이프라인 예시</h4> <p><img src="/assets/images/gcp.JPG" alt="gcp" width="60%" height="60%"></p> </article> <script src="https://utteranc.es/client.js" repo="seoyoungh/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Seoyoung Hong. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-453QGGY7P1"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-453QGGY7P1");</script> </body> </html>